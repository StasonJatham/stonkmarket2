{% extends "base.html" %}
{% block content %}
<div class="mb-4">
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
    <div>
      <h1 class="hero-title mb-1">Market dips, distilled.</h1>
      <p class="hero-subtitle mb-0">Track drawdowns, spot bargains, and tune your triggers in real time.</p>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-md-6 d-none d-md-block">
    <div class="stat-tile">
      <div class="stat-label">Tracked symbols</div>
      <div class="stat-value" id="stat-symbols">—</div>
      <div class="text-muted small" id="stat-symbols-note">Loading…</div>
    </div>
  </div>
  <div class="col-12 col-md-6">
    <div class="stat-tile">
      <div class="stat-label">Top dip</div>
      <div class="stat-value" id="stat-top">—</div>
      <div class="text-muted small" id="stat-top-note">Pending refresh</div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12">
    <div class="card glass anim-soft chart-card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="d-flex align-items-center gap-2">
            <h5 class="card-title mb-0"><i class="bi bi-currency-bitcoin me-2"></i>Chart</h5>
            <span class="badge-soft" id="chart-symbol">Select a symbol</span>
          </div>
          <div class="d-flex flex-nowrap gap-1 range-btn-group" role="group" aria-label="Range selector" style="overflow-x:auto;">
            <button type="button" class="btn btn-outline-primary btn-sm range-btn hit-target px-2 py-1" style="font-size:0.8rem;" data-days="30">30d</button>
            <button type="button" class="btn btn-outline-primary btn-sm range-btn hit-target px-2 py-1" style="font-size:0.8rem;" data-days="90">90d</button>
            <button type="button" class="btn btn-outline-primary btn-sm range-btn hit-target px-2 py-1" style="font-size:0.8rem;" data-days="180">180d</button>
            <button type="button" class="btn btn-outline-primary btn-sm range-btn hit-target px-2 py-1" style="font-size:0.8rem;" data-days="365">365d</button>
          </div>
        </div>
        <div class="position-relative" style="height: 420px;">
          <div id="chart-skeleton" class="skeleton position-absolute top-0 start-0 w-100 h-100"></div>
          <canvas id="chart" height="380" role="img" aria-label="Price history chart"></canvas>
        </div>
        <div id="chart-summary" class="text-muted small mt-2" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card glass anim-soft">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0"><i class="bi bi-graph-down-arrow me-2"></i>Dip Ranking</h5>
          <span class="text-muted small" id="updated-at" aria-live="polite">—</span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle" id="ranking-table">
            <thead>
              <tr class="d-none d-md-table-row">
                <th>Symbol</th>
                <th class="text-end">Depth</th>
                <th class="text-end">Days since dip</th>
                <th class="text-end">Price</th>
                <th class="text-end">52w High</th>
                <th class="text-end">52w Low</th>
              </tr>
              <tr class="d-table-row d-md-none text-muted small">
                <th colspan="6">
                  <div class="d-flex flex-wrap gap-3">
                    <span>Symbol</span>
                    <span>Depth</span>
                    <span>Days</span>
                    <span>Price</span>
                    <span>52w H</span>
                    <span>52w L</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
let chart;
let lastSymbol = null;
const chartCache = {};
const storedDays = parseInt(localStorage.getItem('chartDays'), 10);
let currentDays = [30,90,180,365].includes(storedDays) ? storedDays : 90;
const storedSymbol = localStorage.getItem('chartSymbol');

async function fetchRanking() {
  const now = Date.now();
  if (window._rankingCache && now - window._rankingCache.ts < 60_000) {
    return window._rankingCache.data;
  }
  const res = await fetch('/api/dips/ranking');
  const data = await res.json();
  window._rankingCache = {ts: now, data};
  return data;
}
async function refreshRanking() {
  const btn = document.getElementById('refresh-btn');
  const spinner = document.getElementById('refresh-spinner');
  if (btn && spinner) {
    btn.disabled = true; spinner.classList.remove('d-none');
  }
  const res = await fetch('/api/dips/refresh', {method: 'POST'});
  if (res.ok) {
    await loadAll();
  }
  if (btn && spinner) {
    btn.disabled = false; spinner.classList.add('d-none');
  }
}
async function loadRanking() {
  const data = await fetchRanking();
  const tbody = document.querySelector('#ranking-table tbody');
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="2" class="table-empty">No dips yet</td></tr>';
  }
  data.forEach(row => {
    const daysSince = row.days_since_dip != null ? row.days_since_dip : '—';
    const lastPrice = row.last_price != null ? row.last_price.toFixed(2) : '—';
    const high52w = row.high_52w != null ? row.high_52w.toFixed(2) : '—';
    const low52w = row.low_52w != null ? row.low_52w.toFixed(2) : '—';

    // Mobile: single-line inline summary
    const mobileRow = document.createElement('tr');
    mobileRow.className = 'd-table-row d-md-none';
    mobileRow.innerHTML = `<td colspan="6">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <span class="fw-semibold">${row.symbol}</span>
        <span class="text-danger">${(row.depth*100).toFixed(2)}%</span>
        <span class="text-muted">${daysSince}d</span>
        <span class="text-muted">${lastPrice}</span>
        <span class="text-muted">H:${high52w}</span>
        <span class="text-muted">L:${low52w}</span>
      </div>
    </td>`;

    // Desktop row with full columns
    const desktopRow = document.createElement('tr');
    desktopRow.className = 'd-none d-md-table-row';
    desktopRow.style.cursor = 'pointer';
    desktopRow.innerHTML = `<td data-label="Symbol">${row.symbol}</td>`+
      `<td class="text-end" data-label="Depth">${(row.depth*100).toFixed(2)}%</td>`+
      `<td class="text-end" data-label="Days since dip">${daysSince}</td>`+
      `<td class="text-end" data-label="Price">${lastPrice}</td>`+
      `<td class="text-end" data-label="52w High">${high52w}</td>`+
      `<td class="text-end" data-label="52w Low">${low52w}</td>`;

    mobileRow.addEventListener('click', () => loadChart(row.symbol));
    desktopRow.addEventListener('click', () => loadChart(row.symbol));

    tbody.appendChild(mobileRow);
    tbody.appendChild(desktopRow);
  });
  const top = data[0];
  if (top) {
    document.getElementById('stat-top').textContent = `${top.symbol}`;
    const topDays = top.days_since_dip != null ? `${top.days_since_dip}d since dip` : 'No dip start yet';
    document.getElementById('stat-top-note').textContent = `${(top.depth*100).toFixed(2)}% drawdown · ${topDays}`;
    const preferred = data.find(d => d.symbol === storedSymbol) || top;
    prefetchChart(preferred.symbol);
    if (!lastSymbol) {
      loadChart(preferred.symbol);
    }
  } else {
    document.getElementById('stat-top').textContent = '—';
    document.getElementById('stat-top-note').textContent = 'No qualifying dips';
  }
  document.getElementById('updated-at').textContent = `Updated ${new Date().toLocaleTimeString()}`;
}

async function prefetchChart(symbol) {
  const cacheKey = `${symbol}-${currentDays}`;
  if (chartCache[cacheKey]) return;
  const res = await fetch(`/api/dips/${symbol}/history?days=${currentDays}`);
  chartCache[cacheKey] = await res.json();
}
async function loadChart(symbol) {
  document.getElementById('chart-skeleton').classList.remove('d-none');
  document.getElementById('chart-symbol').textContent = symbol;
  const cacheKey = `${symbol}-${currentDays}`;
  let data = chartCache[cacheKey];
  if (!data) {
    const res = await fetch(`/api/dips/${symbol}/history?days=${currentDays}`);
    data = await res.json();
    chartCache[cacheKey] = data;
  }
  localStorage.setItem('chartSymbol', symbol);
  const labels = data.map(p => p.date);
  const prices = data.map(p => p.close);
  const threshold = data.map(p => p.threshold);
  const drawdowns = data.map(p => p.drawdown);
  const sinceDipArr = data.map(p => p.since_dip);
  const thresholdVal = threshold.length ? threshold[0] : null;
  const refHighDate = data.length ? (data[0].ref_high_date || '—') : '—';
  const dipStartDate = data.length ? (data[0].dip_start_date || '—') : '—';
  const thresholdSeries = threshold.map((t, i) => {
    if (!dipStartDate || dipStartDate === '—') return t;
    return labels[i] >= dipStartDate ? t : null;
  });
  const ctx = document.getElementById('chart').getContext('2d');
  lastSymbol = symbol;
  const styles = getComputedStyle(document.body);
  const accent = styles.getPropertyValue('--accent').trim();
  const danger = styles.getPropertyValue('--danger').trim();
  const grid = styles.getPropertyValue('--grid').trim();
  const text = styles.getPropertyValue('--text').trim();
  const panel = styles.getPropertyValue('--panel').trim();
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function hexToRgba(hex, alpha) {
    const clean = hex.replace('#','').slice(0,6);
    const num = parseInt(clean, 16);
    const r = (num >> 16) & 255;
    const g = (num >> 8) & 255;
    const b = num & 255;
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  const gradient = ctx.createLinearGradient(0, 0, 0, 260);
  gradient.addColorStop(0, hexToRgba(accent, 0.25));
  gradient.addColorStop(1, hexToRgba(accent, 0));
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label: 'Close', data: prices, borderColor: accent, backgroundColor: gradient, fill: true, tension: 0.25, pointRadius: 0},
        {label: 'Threshold', data: thresholdSeries, borderColor: danger, borderDash: [6,4], tension: 0.2, pointRadius: 0, fill: false},
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: prefersReduced ? false : {duration: 250, easing: 'easeOutCubic'},
      plugins: {
        legend: {display: true, labels: {color: text, usePointStyle: true}},
        tooltip: {
          mode: 'index', intersect: false,
          backgroundColor: panel || '#fff', titleColor: text, bodyColor: text,
          callbacks: {
            label: (ctxItem) => {
              const i = ctxItem.dataIndex;
              const price = prices[i];
              const th = threshold[i];
              const sinceDip = sinceDipArr[i] != null ? sinceDipArr[i] * 100 : null;
              const drawdown = drawdowns[i] != null ? drawdowns[i] * 100 : null;
              const parts = [`Close: ${price.toFixed(2)}`];
              if (ctxItem.datasetIndex === 0) {
                if (th) parts.push(`Threshold: ${th.toFixed(2)}`);
                if (sinceDip !== null) parts.push(`Since dip: ${sinceDip.toFixed(2)}%`);
                if (drawdown !== null) parts.push(`From high: ${drawdown.toFixed(2)}%`);
              }
              return parts;
            }
          }
        }
      },
      scales: {
        x: {grid: {color: grid}, ticks: {color: text}},
        y: {grid: {color: grid}, ticks: {color: text}, title: {display: true, text: 'Price'}}
      },
      interaction: {mode: 'index', intersect: false}
    }
  });
  document.getElementById('chart-skeleton').classList.add('d-none');

  const summary = document.getElementById('chart-summary');
  if (data.length) {
    const latestPrice = prices[prices.length - 1];
    const latestDraw = drawdowns[drawdowns.length - 1] != null ? (drawdowns[drawdowns.length - 1] * 100).toFixed(2) : null;
    const minPrice = Math.min(...prices);
    const maxPrice = Math.max(...prices);
    const sinceDip = sinceDipArr[sinceDipArr.length - 1] != null ? (sinceDipArr[sinceDipArr.length - 1] * 100).toFixed(2) : null;
    const thresholdLine = thresholdVal != null ? thresholdVal.toFixed(2) : '—';
    summary.textContent = `Latest ${symbol}: ${latestPrice.toFixed(2)} | From 400d high (${refHighDate}): ${latestDraw ?? '—'}% | Dip start: ${dipStartDate} (since: ${sinceDip ?? '—'}%) | Threshold: ${thresholdLine} | Range: ${minPrice.toFixed(2)}–${maxPrice.toFixed(2)}`;
  } else {
    summary.textContent = 'No data available for this symbol.';
  }
}
async function loadStats() {
  const symbolsRes = await fetch('/api/symbols');
  const symbols = await symbolsRes.json();
  document.getElementById('stat-symbols').textContent = symbols.length;
  document.getElementById('stat-symbols-note').textContent = 'Configured tickers';
}

async function loadAll() {
  await Promise.all([loadStats(), loadRanking()]);
}

loadAll();
document.addEventListener('theme-changed', () => {
  if (lastSymbol) {
    loadChart(lastSymbol);
  }
});

document.querySelectorAll('.range-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    currentDays = parseInt(btn.dataset.days, 10);
    localStorage.setItem('chartDays', String(currentDays));
    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (lastSymbol) {
      loadChart(lastSymbol);
    }
  });
});

// set initial active range button
document.querySelectorAll('.range-btn').forEach(btn => {
  if (parseInt(btn.dataset.days, 10) === currentDays) {
    btn.classList.add('active');
  }
});
</script>
{% endblock %}

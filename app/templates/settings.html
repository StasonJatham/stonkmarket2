{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-6">
    <div class="card glass anim-soft">
      <div class="card-body">
        <h5 class="card-title mb-3">Account</h5>
        <div class="mb-3">
          <label class="form-label">Current password</label>
          <input type="password" class="form-control" id="current-password" autocomplete="current-password">
        </div>
        <div class="mb-3">
          <label class="form-label">New username</label>
          <input type="text" class="form-control" id="new-username" autocomplete="username">
        </div>
        <div class="mb-3">
          <label class="form-label">New password</label>
          <input type="password" class="form-control" id="new-password" autocomplete="new-password">
        </div>
        <div class="d-grid">
          <button class="btn btn-primary" id="save-cred-btn">Update credentials</button>
        </div>
        <div class="small mt-2" id="cred-message"></div>
      </div>
    </div>
  </div>
</div>
<script>
  async function requireAuth() {
    const res = await fetch('/api/auth/me', {credentials: 'include'});
    if (!res.ok) {
      window.location.href = '/login';
    }
  }
  requireAuth();

  document.getElementById('save-cred-btn').addEventListener('click', async () => {
    const current_password = document.getElementById('current-password').value;
    const new_username = document.getElementById('new-username').value.trim();
    const new_password = document.getElementById('new-password').value;
    const msg = document.getElementById('cred-message');
    msg.textContent = '';
    try {
      const res = await fetch('/api/auth/change', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({current_password, new_username, new_password})
      });
      if (!res.ok) {
        msg.textContent = 'Update failed. Check password and try again.';
        msg.className = 'small mt-2 text-danger';
        return;
      }
      msg.textContent = 'Updated. You are now signed in with the new credentials.';
      msg.className = 'small mt-2 text-success';
    } catch (e) {
      msg.textContent = 'Update failed. Try again.';
      msg.className = 'small mt-2 text-danger';
    }
  });
</script>
{% endblock %}

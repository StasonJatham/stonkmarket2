{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
  <div>
    <div class="badge-soft mb-2">Universe</div>
    <h2 class="hero-title h3 mb-1">Manage tracked symbols</h2>
    <p class="hero-subtitle mb-0">Tune dip thresholds per ticker to match your playbook.</p>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-primary" onclick="openAdd()">Add symbol</button>
  </div>
</div>

<div class="card glass anim-soft">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm align-middle stacked-table" id="symbols-table">
        <thead><tr><th>Symbol</th><th>Min Dip %</th><th>Min Days</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Symbol</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="symbol-form">
          <input type="hidden" id="symbol-input">
          <div class="mb-3">
            <label class="form-label">Symbol</label>
            <input class="form-control" id="symbol-display" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">Min Dip %</label>
            <input type="number" step="0.01" class="form-control" id="min-dip">
          </div>
          <div class="mb-3">
            <label class="form-label">Min Days</label>
            <input type="number" class="form-control" id="min-days">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" onclick="saveSymbol()">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
let modal;

async function requireAuth() {
  const res = await fetch('/api/auth/me', {credentials: 'include'});
  if (!res.ok) {
    window.location.href = '/login';
  }
}

async function loadSymbols() {
  const res = await fetch('/api/symbols', {credentials: 'include'});
  if (res.status === 401) { window.location.href = '/login'; return; }
  const data = await res.json();
  const tbody = document.querySelector('#symbols-table tbody');
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="table-empty">No symbols yet. Add one to start monitoring dips.</td></tr>';
    return;
  }
  data.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td data-label="Symbol">${s.symbol}</td><td data-label="Min Dip %">${(s.min_dip_pct*100).toFixed(1)}%</td><td data-label="Min Days">${s.min_days}</td>` +
      `<td class="text-end" data-label="Actions">`+
      `<button class="btn btn-sm btn-outline-primary me-2" onclick="editSymbol('${s.symbol}', ${s.min_dip_pct}, ${s.min_days})">Edit</button>`+
      `<button class="btn btn-sm btn-outline-danger" onclick="deleteSymbol('${s.symbol}')">Delete</button>`+
      `</td>`;
    tbody.appendChild(tr);
  });
}

function openAdd() {
  document.getElementById('symbol-input').value = '';
  document.getElementById('symbol-display').disabled = false;
  document.getElementById('symbol-display').value = '';
  document.getElementById('min-dip').value = 0.10;
  document.getElementById('min-days').value = 2;
  modal = new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}

function editSymbol(symbol, minDip, minDays) {
  document.getElementById('symbol-input').value = symbol;
  document.getElementById('symbol-display').disabled = true;
  document.getElementById('symbol-display').value = symbol;
  document.getElementById('min-dip').value = minDip;
  document.getElementById('min-days').value = minDays;
  modal = new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}

async function saveSymbol() {
  const symbol = document.getElementById('symbol-input').value || document.getElementById('symbol-display').value;
  const minDip = parseFloat(document.getElementById('min-dip').value);
  const minDays = parseInt(document.getElementById('min-days').value, 10);
  const payload = {min_dip_pct: minDip, min_days: minDays};
  if (!symbol) return;
  if (document.getElementById('symbol-input').value) {
    await fetch(`/api/symbols/${symbol}`, {method: 'PUT', headers: {'Content-Type': 'application/json'}, credentials: 'include', body: JSON.stringify(payload)});
  } else {
    await fetch('/api/symbols', {method: 'POST', headers: {'Content-Type': 'application/json'}, credentials: 'include', body: JSON.stringify({...payload, symbol})});
  }
  modal.hide();
  loadSymbols();
}

async function deleteSymbol(symbol) {
  await fetch(`/api/symbols/${symbol}`, {method: 'DELETE', credentials: 'include'});
  loadSymbols();
}

  (async () => {
    await requireAuth();
    loadSymbols();
  })();
</script>
{% endblock %}
